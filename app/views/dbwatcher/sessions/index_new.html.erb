<%# Sessions Index Page %>
<%= render 'dbwatcher/shared/page_layout', 
    page_title: 'Tracking Sessions', 
    page_subtitle: "#{@sessions.count} sessions",
    tabs: [
      { name: 'All Sessions', active: true },
      { name: 'Active', active: false },
      { name: 'Recent', active: false }
    ],
    toolbar: capture do %>
      <input type="text" placeholder="Filter sessions..." 
             class="compact-input flex-1 max-w-xs">
      <select class="compact-select">
        <option>Last 24 hours</option>
        <option>Last week</option>
        <option>All time</option>
      </select>
      
      <div class="ml-auto flex items-center gap-2">
        <button class="compact-button bg-blue-medium text-white hover:bg-blue-700">
          <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
          </svg>
          Refresh
        </button>
        
        <%= button_to clear_sessions_path, 
                      method: :delete,
                      class: "compact-button bg-red-600 text-white hover:bg-red-700",
                      data: { 
                        confirm: "Are you sure you want to clear all sessions? This action cannot be undone." 
                      } do %>
          <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V7a1 1 0 00-1-1z"/>
          </svg>
          Clear Sessions
        <% end %>
      </div>
    <% end %> do %>

  <% if @sessions.empty? %>
    <%= empty_state "No tracking sessions yet", 
        icon: content_tag(:svg, class: "mx-auto h-8 w-8 text-gray-400 mb-2", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24") do
          content_tag(:path, "", "stroke-linecap": "round", "stroke-linejoin": "round", "stroke-width": "1", 
                      d: "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2")
        end + content_tag(:p, "Start tracking with ", class: "text-xs text-gray-400") + 
        content_tag(:code, "Dbwatcher.track { ... }", class: "bg-gray-200 px-1 rounded") %>
  <% else %>
    <table class="compact-table w-full">
      <thead>
        <tr>
          <th class="text-left">Session ID</th>
          <th class="text-left">Name</th>
          <th class="text-center">Status</th>
          <th class="text-center">Changes</th>
          <th class="text-right">Started</th>
          <th class="text-right">Duration</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @sessions.each do |session| %>
          <tr class="hover:bg-blue-50">
            <td class="font-mono text-xs">
              <%= safe_value(session, :id, 'N/A')[0..7] %>...
            </td>
            <td class="max-w-xs truncate" title="<%= safe_value(session, :name) %>">
              <%= link_to safe_value(session, :name), session_path(safe_value(session, :id)), 
                  class: "text-navy-dark hover:text-blue-medium" %>
            </td>
            <td class="text-center">
              <%= render 'dbwatcher/shared/badge', 
                  content: (safe_value(session, :ended_at).present? ? 'Completed' : 'Active'),
                  badge_class: (safe_value(session, :ended_at).present? ? 'badge-primary' : 'badge-success') %>
            </td>
            <td class="text-center">
              <%= render 'dbwatcher/shared/badge', 
                  content: safe_value(session, :change_count, 0),
                  badge_class: 'bg-gray-600 text-white' %>
            </td>
            <td class="text-right text-xs">
              <%= format_timestamp(safe_value(session, :started_at)) %>
            </td>
            <td class="text-right text-xs">
              <% if safe_value(session, :ended_at).present? %>
                <%= distance_of_time_in_words(
                    Time.parse(safe_value(session, :started_at)), 
                    Time.parse(safe_value(session, :ended_at))
                  ) rescue 'N/A' %>
              <% else %>
                <span class="text-blue-600">Active</span>
              <% end %>
            </td>
            <td class="text-center">
              <%= link_to session_path(safe_value(session, :id)), 
                  class: "text-blue-600 hover:text-blue-800" do %>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <!-- Status Bar -->
  <div class="h-6 bg-gray-100 border-t border-gray-300 flex items-center px-4 text-xs text-gray-600">
    <%= @sessions.count %> sessions total • 
    <%= @sessions.count { |s| !(safe_value(s, :ended_at)) } %> active •
    Last updated: <%= Time.current.strftime("%H:%M:%S") %>
  </div>

<% end %>
