<!DOCTYPE html>
<html>
  <head>
    <title>DB Watcher</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>

    <!-- Alpine.js and Plugins - ensure plugins load BEFORE Alpine.js core -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Mermaid.js for database diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js" crossorigin="anonymous"></script>

    <!-- SVG Pan Zoom Library -->
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

    <!-- Tabulator.js for table library -->
    <%= javascript_include_tag "dbwatcher/vendor/tabulator.min" %>
    <%= stylesheet_link_tag "dbwatcher/vendor/tabulator.min", media: "all" %>

    <!-- DBWatcher Core Architecture -->
    <%= javascript_include_tag "dbwatcher/vendor/lodash.min" %>
    <%= javascript_include_tag "dbwatcher/vendor/date-fns-browser" %>
    <%= javascript_include_tag "dbwatcher/dbwatcher" %>
    <%= javascript_include_tag "dbwatcher/core/component_registry" %>
    <%= javascript_include_tag "dbwatcher/core/component_loader" %>
    <%= javascript_include_tag "dbwatcher/components/base" %>
    <%= javascript_include_tag "dbwatcher/components/changes_table_hybrid" %>
    <%= javascript_include_tag "dbwatcher/components/diagrams" %>
    <%= javascript_include_tag "dbwatcher/components/summary" %>

    <!-- DBWatcher Services -->
    <%= javascript_include_tag "dbwatcher/core/alpine_store" %>
    <%= javascript_include_tag "dbwatcher/core/api_client" %>
    <%= javascript_include_tag "dbwatcher/services/mermaid" %>

    <!-- Alpine.js Component Registrations -->
    <%= javascript_include_tag "dbwatcher/alpine_registrations" %>

    <!-- Auto-initialization -->
    <%= javascript_include_tag "dbwatcher/auto_init" %>

    <script>
      // Initialize DBWatcher before Alpine.js starts
      document.addEventListener('alpine:init', () => {
        try {
          if (window.DBWatcher) {
            DBWatcher.init();
            console.log('✅ DBWatcher initialized with optimized architecture');
          } else {
            console.error('❌ DBWatcher not loaded');
          }
        } catch (error) {
          console.error('❌ Error during DBWatcher initialization:', error);
        }
      });

      // Fallback initialization with better error handling
      document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure Alpine is available
        setTimeout(() => {
          try {
            if (window.DBWatcher && !DBWatcher.initialized) {
              DBWatcher.init();
              console.log('✅ DBWatcher initialized (fallback)');
            }
          } catch (error) {
            console.error('❌ Error during DBWatcher fallback initialization:', error);
          }
        }, 100);

        // Plugin verification
        setTimeout(() => {
          if (window.Alpine && !window.Alpine.directive('collapse')) {
            console.warn('⚠️ Alpine.js Collapse plugin may not be properly loaded');
          } else if (window.Alpine && window.Alpine.directive('collapse')) {
            console.log('✅ Alpine.js Collapse plugin verified');
          }
        }, 200);
      });
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom styles for compact theme -->
    <style>
      :root {
        --navy-dark: #00285D;
        --blue-light: #96C1E7;
        --blue-medium: #6CADDF;
        --gold-dark: #D4A11E;
        --gold-light: #FFC758;

        /* Layout dimensions for diagram container */
        --header-height: 64px;
        --tab-bar-height: 32px;
        --toolbar-height: 56px;
        --footer-height: 0px;
      }

      /* Compact table styles */
      .compact-table {
        font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;
        font-size: 12px;
        line-height: 1.2;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .compact-table th {
        padding: 4px 8px;
        font-weight: 500;
        text-transform: none;
        font-size: 11px;
        background: #f3f3f3;
        border-bottom: 2px solid #e8e8e8;
        border-right: 1px solid #e8e8e8;
        position: sticky;
        top: 0;
        z-index: 10;
        text-align: left;
        height: 32px;
      }

      /* Enhanced sticky header styling */
      .compact-table th.sticky-left-0 {
        position: sticky;
        left: 0;
        z-index: 20;
        box-shadow: 2px 0px 3px rgba(0,0,0,0.05);
      }

      .compact-table th.sticky-left-1 {
        position: sticky;
        left: 60px; /* Width of Index column */
        z-index: 19;
        box-shadow: 2px 0px 3px rgba(0,0,0,0.05);
      }

      .compact-table th.sticky-left-2 {
        position: sticky;
        left: 108px; /* Width of Index + Op columns (60px + 48px) */
        z-index: 18;
        box-shadow: 2px 0px 3px rgba(0,0,0,0.05);
      }

      .compact-table td {
        padding: 2px 8px;
        border-right: 1px solid #f0f0f0;
        border-bottom: 1px solid #f0f0f0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: top;
      }

      /* Enhanced sticky cell styling */
      .compact-table td.sticky-left-0 {
        position: sticky;
        left: 0;
        background: white;
        z-index: 5;
        box-shadow: 2px 0px 3px rgba(0,0,0,0.05);
      }

      .compact-table td.sticky-left-1 {
        position: sticky;
        left: 60px; /* Width of Index column */
        background: white;
        z-index: 4;
        box-shadow: 2px 0px 3px rgba(0,0,0,0.05);
      }

      .compact-table td.sticky-left-2 {
        position: sticky;
        left: 108px; /* Width of Index + Op columns (60px + 48px) */
        background: white;
        z-index: 3;
        box-shadow: 2px 0px 3px rgba(0,0,0,0.05);
      }

      /* Special cell formatting */
      .compact-table td.highlight-change {
        background-color: rgba(255, 240, 200, 0.5);
      }

      .compact-table td.highlight-new {
        color: #047857;
      }

      .compact-table td.highlight-deleted {
        color: #b91c1c;
      }

      /* Row styles */
      .compact-table tr:hover td:not(.sticky-left-0):not(.sticky-left-1):not(.sticky-left-2) {
        background-color: rgba(243, 244, 246, 0.7);
      }

      .compact-table tr:hover td.sticky-left-0,
      .compact-table tr:hover td.sticky-left-1,
      .compact-table tr:hover td.sticky-left-2 {
        background-color: #f9fafb;
      }

      .compact-table tr.selected td:not(.sticky-left-0):not(.sticky-left-1):not(.sticky-left-2) {
        background-color: rgba(230, 243, 255, 0.7);
      }

      .compact-table tr.selected td.sticky-left-0,
      .compact-table tr.selected td.sticky-left-1,
      .compact-table tr.selected td.sticky-left-2 {
        background-color: #e6f3ff;
      }

      /* Sidebar styles */
      .sidebar-item {
        font-size: 13px;
        padding: 6px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-radius: 3px;
        transition: all 0.15s;
      }

      .sidebar-item:hover {
        background: rgba(108, 173, 223, 0.1);
        color: #6CADDF;
      }

      .sidebar-item.active {
        background: #00285D;
        color: white;
      }

      /* Compact form controls */
      .compact-input {
        padding: 3px 8px;
        font-size: 12px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
      }

      .compact-select {
        padding: 3px 24px 3px 8px;
        font-size: 12px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        background-size: 16px;
      }

      .compact-button {
        padding: 4px 12px;
        font-size: 12px;
        border-radius: 3px;
        font-weight: 500;
      }

      /* Tab styles */
      .tab-bar {
        background: #f3f3f3;
        border-bottom: 1px solid #e8e8e8;
        display: flex;
        align-items: center;
        height: 32px;
        font-size: 12px;
      }

      .tab-item {
        padding: 0 16px;
        height: 100%;
        display: flex;
        align-items: center;
        border-right: 1px solid #e8e8e8;
        cursor: pointer;
        transition: all 0.15s;
      }

      .tab-item:hover {
        background: #e8e8e8;
      }

      .tab-item.active {
        background: white;
        color: #00285D;
        font-weight: 500;
      }

      /* Status badges */
      .badge-insert { background: #10b981; color: white; }
      .badge-update { background: #6CADDF; color: white; }
      .badge-delete { background: #ef4444; color: white; }
      .badge-select { background: #6b7280; color: white; }

      .badge {
        padding: 1px 6px;
        font-size: 10px;
        border-radius: 3px;
        font-weight: 500;
        text-transform: uppercase;
        display: inline-block;
        width: 18px;
        height: 18px;
        line-height: 18px;
        text-align: center;
      }

      /* Smart column width distribution */
      .compact-table th,
      .compact-table td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Fixed widths for sticky columns only */
      .compact-table th:first-child,
      .compact-table td:first-child {
        width: 60px;
        min-width: 60px;
        max-width: 60px;
      }

      .compact-table th:nth-child(2),
      .compact-table td:nth-child(2) {
        width: 48px;
        min-width: 48px;
        max-width: 48px;
        text-align: center;
      }

      .compact-table th:nth-child(3),
      .compact-table td:nth-child(3) {
        width: 160px;
        min-width: 160px;
        max-width: 160px;
        font-family: monospace;
        font-size: 11px;
      }

      /* Font styling for specific column types */
      .compact-table .text-right {
        font-family: monospace;
      }

      .compact-table td:nth-child(3),
      .compact-table th:nth-child(3) {
        font-family: monospace;
        font-size: 11px;
      }

      /* Highlight colors */
      .highlight-change { background: rgba(255, 199, 88, 0.3); }
      .highlight-new { background: rgba(16, 185, 129, 0.2); }
      .highlight-deleted { background: rgba(239, 68, 68, 0.2); }

      /* Splitter */
      .splitter {
        width: 4px;
        background: #e8e8e8;
        cursor: col-resize;
      }

      .splitter:hover {
        background: #6CADDF;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f3f3f3;
      }

      ::-webkit-scrollbar-thumb {
        background: #c8c8c8;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #6CADDF;
      }

      /* Enhanced table styles for data readability */
      .table-detailed .compact-table td {
        max-width: 300px;
        padding: 4px 8px;
      }

      .cell-content {
        position: relative;
        display: inline-block;
        max-width: 100%;
      }

      .cell-compact {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .cell-detailed {
        max-width: 300px;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .cell-value {
        cursor: help;
      }

      /* Column type styling */
      .column-meta {
        background-color: rgba(156, 163, 175, 0.1);
      }

      .column-timestamp {
        background-color: rgba(59, 130, 246, 0.1);
        font-family: monospace;
      }

      .column-id {
        background-color: rgba(245, 158, 11, 0.1);
        font-family: monospace;
      }

      /* Tooltip improvements */
      .tooltip-content {
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;
      }

      /* Essential mode adjustments */
      .view-essential .compact-table th,
      .view-essential .compact-table td {
        font-size: 11px;
        padding: 2px 6px;
      }

      /* JSON/Array content indicators */
      .json-indicator {
        color: #6366f1;
        font-style: italic;
        font-size: 10px;
      }

      .array-indicator {
        color: #059669;
        font-style: italic;
        font-size: 10px;
      }

      /* Diagram styles */
      .mermaid {
        text-align: center;
        padding: 20px;
        background: #fafafa;
        border-radius: 4px;
      }

      .mermaid svg {
        max-width: 100%;
        height: auto !important;
        min-height: 150px;
        margin: 0 auto;
        display: block;
      }

      #diagram-container {
        min-height: 300px;
        max-height: 600px;
        overflow: auto;
        padding: 10px;
        background: white;
        position: relative;
      }

      .mermaid-wrapper {
        display: inline-block;
        min-width: 100%;
        transform-origin: center top;
        transition: transform 0.2s ease;
      }

      /* Responsive diagram container */
      @media (max-width: 768px) {
        #diagram-container {
          max-height: 400px;
        }
      }

      /* Ensure SVG paths have some minimal stroke */
      .mermaid svg path {
        stroke-width: 1.5px;
        vector-effect: non-scaling-stroke;
      }

      /* Better visibility for nodes */
      .mermaid .node rect,
      .mermaid .node circle,
      .mermaid .node ellipse,
      .mermaid .node polygon,
      .mermaid .entityBox {
        stroke-width: 1.5px !important;
        fill: #fff !important;
        stroke: #333 !important;
      }

      /* Flowchart specific styles (for model associations) */
      .mermaid .flowchart-link {
        stroke-width: 2px !important;
        fill: none !important;
      }

      .mermaid .edgeLabel {
        background-color: #fff !important;
        border-radius: 4px !important;
        padding: 2px 4px !important;
        font-size: 12px !important;
      }

      /* Make sure marker-end arrows are visible */
      .mermaid marker {
        fill: #333 !important;
        stroke: none !important;
      }

      /* Ensure SVG elements have minimum dimensions */
      .mermaid .flowchart-link path {
        stroke-width: 2px !important;
        min-width: 2px !important;
        min-height: 2px !important;
      }
    </style>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'navy-dark': '#00285D',
              'blue-light': '#96C1E7',
              'blue-medium': '#6CADDF',
              'gold-dark': '#D4A11E',
              'gold-light': '#FFC758',
            }
          }
        }
      }
    </script>
  </head>

  <body class="bg-gray-50 h-screen overflow-hidden text-gray-800">
    <div class="flex h-full" x-data="{ sidebarWidth: 200, sidebarCollapsed: false }">
      <!-- Compact Sidebar -->
      <aside class="bg-gray-900 text-gray-300 flex-shrink-0 transition-all duration-200"
             :style="{ width: sidebarCollapsed ? '48px' : sidebarWidth + 'px' }">
        <div class="flex flex-col h-full">
          <!-- Logo -->
          <div class="h-10 flex items-center justify-between px-3 border-b border-gray-700">
            <div class="flex items-center gap-2" x-show="!sidebarCollapsed">
              <svg class="w-5 h-5 text-gold-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <span class="text-sm font-medium text-white">DB Watcher</span>
            </div>
            <button @click="sidebarCollapsed = !sidebarCollapsed"
                    class="p-1 hover:bg-gray-800 rounded text-gray-400">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      :d="sidebarCollapsed ? 'M13 5l7 7-7 7M5 5l7 7-7 7' : 'M11 19l-7-7 7-7m8 14l-7-7 7-7'"/>
              </svg>
            </button>
          </div>

          <!-- Navigation -->
          <nav class="flex-1 py-2 overflow-y-auto">
            <%= link_to root_path, class: "sidebar-item #{current_page?(root_path) ? 'active' : ''}" do %>
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
              </svg>
              <span x-show="!sidebarCollapsed">Dashboard</span>
            <% end %>

            <%= link_to sessions_path, class: "sidebar-item #{current_page?(sessions_path) ? 'active' : ''}" do %>
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span x-show="!sidebarCollapsed">Sessions</span>
            <% end %>

            <%= link_to tables_path, class: "sidebar-item #{current_page?(tables_path) ? 'active' : ''}" do %>
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <span x-show="!sidebarCollapsed">Tables</span>
            <% end %>

            <%= link_to queries_path, class: "sidebar-item #{current_page?(queries_path) ? 'active' : ''}" do %>
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span x-show="!sidebarCollapsed">SQL Logs</span>
            <% end %>
          </nav>

          <!-- Actions -->
          <div class="p-2 border-t border-gray-700">
            <!-- Clear All Action -->
            <%= button_to clear_all_path,
                method: :delete,
                data: { confirm: "Clear all data?" },
                class: "sidebar-item w-full justify-center bg-red-900 hover:bg-red-800 text-red-200" do %>
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              <span x-show="!sidebarCollapsed" class="text-xs">Clear All</span>
            <% end %>
          </div>
        </div>
      </aside>

      <!-- Splitter -->
      <div class="splitter" x-show="!sidebarCollapsed"
           @mousedown="startResize($event)"
           x-data="{
             startResize(e) {
               const startX = e.pageX;
               const startWidth = sidebarWidth;

               const doDrag = (e) => {
                 sidebarWidth = Math.max(150, Math.min(400, startWidth + e.pageX - startX));
               };

               const stopDrag = () => {
                 document.removeEventListener('mousemove', doDrag);
                 document.removeEventListener('mouseup', stopDrag);
               };

               document.addEventListener('mousemove', doDrag);
               document.addEventListener('mouseup', stopDrag);
             }
           }">
      </div>

      <!-- Main Content -->
      <main class="flex-1 overflow-hidden bg-white">
        <%= yield %>
      </main>
    </div>

    <!-- Initialize DBWatcher system -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize DBWatcher if available
        if (window.DBWatcher) {
          // Ensure BaseComponent is available
          if (!window.DBWatcher.BaseComponent && typeof DBWatcher.BaseComponent !== 'function') {
            window.DBWatcher.BaseComponent = function(config = {}) {
              return {
                init() {
                  if (this.componentInit) {
                    try {
                      this.componentInit();
                    } catch (error) {
                      console.error("Error during component initialization:", error);
                    }
                  }
                }
              };
            };
            console.log('Added fallback BaseComponent');
          }

          // Register legacy components with Alpine directly if ComponentRegistry isn't available
          if (!window.DBWatcher.ComponentRegistry) {
            console.log('ComponentRegistry not available, using direct Alpine registration');

            // Ensure Alpine is available
            if (window.Alpine) {
              // Direct registration of components with Alpine
              if (!window.Alpine.data('changesTable') && window.DBWatcher.components && window.DBWatcher.components.changesTable) {
                window.Alpine.data('changesTable', (config = {}) => {
                  const component = window.DBWatcher.components.changesTable(config);
                  return component;
                });
                console.log('Registered changesTable component with Alpine');
              }
            }
          }

          console.log('✅ DBWatcher initialized (fallback)');
        }

        // Verify Alpine.js plugins
        if (window.Alpine && window.Alpine.directive && window.Alpine.directive('collapse')) {
          console.log('✅ Alpine.js Collapse plugin verified');
        }
      });
    </script>
  </body>
</html>
