name: Release Gem

permissions:
  contents: write
  packages: write
  id-token: write

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.2)"
        required: true
        type: string
      dry_run:
        description: "Dry run (skip actual publishing)"
        required: false
        type: boolean
        default: false

env:
  RUBY_VERSION: "3.3"

jobs:
  validate-release:
    runs-on: ubuntu-latest
    name: Validate Release
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      should_release: ${{ steps.validate.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag or input
        id: extract_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Manual release triggered for version: $VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Tag-triggered release for version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"

          # Check semantic versioning format
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected semantic versioning format: X.Y.Z[-prerelease][+build]"
            exit 1
          fi

          # Verify version consistency with gemspec
          GEMSPEC_VERSION=$(ruby -e "require './lib/dbwatcher/version'; puts Dbwatcher::VERSION")
          echo "Gemspec version: $GEMSPEC_VERSION"
          echo "Release version: $VERSION"

          if [ "$GEMSPEC_VERSION" != "$VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "Gemspec version: $GEMSPEC_VERSION"
            echo "Release version: $VERSION"
            echo "Please update lib/dbwatcher/version.rb to match the release version"
            exit 1
          fi

          # Check if this version already exists on RubyGems
          if gem list dbwatcher --remote --exact | grep -q "($VERSION)"; then
            echo "âŒ Version $VERSION already exists on RubyGems"
            exit 1
          fi

          echo "âœ… Version validation passed"
          echo "should_release=true" >> $GITHUB_OUTPUT

  test:
    needs: validate-release
    runs-on: ubuntu-latest
    name: Test Ruby ${{ matrix.ruby }}
    if: needs.validate-release.outputs.should_release == 'true'
    strategy:
      fail-fast: true
      matrix:
        ruby: ["3.2", "3.3"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true

      - name: Run comprehensive tests
        run: |
          echo "ğŸ§ª Running tests for Ruby ${{ matrix.ruby }}"
          bundle exec rake spec

      - name: Run security scan
        if: matrix.ruby == env.RUBY_VERSION
        run: |
          echo "ğŸ”’ Running security scan"
          bundle exec brakeman --force --format json --output tmp/brakeman-release.json --exit-on-warn || true

      - name: Run quality checks
        if: matrix.ruby == env.RUBY_VERSION
        run: |
          echo "ğŸ“Š Running quality checks"
          bundle exec rubocop

  build-and-publish:
    needs: [validate-release, test]
    runs-on: ubuntu-latest
    name: Build and Publish Gem
    if: needs.validate-release.outputs.should_release == 'true'
    environment:
      name: production
      url: https://rubygems.org/gems/dbwatcher

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Build gem
        id: build
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          echo "ğŸ”¨ Building gem version $VERSION"
          gem build dbwatcher.gemspec

          # Verify gem was built
          GEM_FILE="dbwatcher-${VERSION}.gem"
          if [ ! -f "$GEM_FILE" ]; then
            echo "âŒ Gem file not found: $GEM_FILE"
            exit 1
          fi

          echo "âœ… Gem built successfully: $GEM_FILE"
          echo "gem_file=$GEM_FILE" >> $GITHUB_OUTPUT

      - name: Test gem installation
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          GEM_FILE="dbwatcher-${VERSION}.gem"
          
          echo "ğŸ§ª Testing gem installation in minimal environment"
          
          # Create a minimal test environment with Rails
          mkdir -p gem_test
          cd gem_test
          
          # Create a minimal Gemfile for testing
          cat > Gemfile << EOF
          source 'https://rubygems.org'
          gem 'rails', '>= 6.0'
          gem 'dbwatcher', path: '../$GEM_FILE'
          EOF
          
          # Test installation and loading
          bundle install --local --path vendor/bundle || bundle install --path vendor/bundle
          
          # Test that the gem loads properly
          bundle exec ruby -e "
            require 'bundler/setup'
            require 'dbwatcher'
            puts 'âœ… Gem loads successfully'
            puts 'DBWatcher version: ' + Dbwatcher::VERSION
          "
          
          cd ..
          rm -rf gem_test

      - name: Dry run check
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸƒâ€â™‚ï¸ DRY RUN MODE - Skipping actual publishing"
          echo "Would publish: ${{ steps.build.outputs.gem_file }}"
          exit 0

      - name: Setup RubyGems credentials
        if: github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p ~/.gem
          cat > ~/.gem/credentials << EOF
          ---
          :rubygems_api_key: ${{ secrets.RUBYGEMS_API_KEY }}
          EOF
          chmod 0600 ~/.gem/credentials

      - name: Publish to RubyGems
        if: github.event.inputs.dry_run != 'true'
        id: publish
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          GEM_FILE="${{ steps.build.outputs.gem_file }}"

          echo "ğŸš€ Publishing $GEM_FILE to RubyGems"
          gem push "$GEM_FILE"

          echo "âœ… Successfully published dbwatcher $VERSION to RubyGems"
          echo "published=true" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate-release.outputs.version }}
          name: Release ${{ needs.validate-release.outputs.version }}
          body: |
            ## ğŸš€ DB Watcher v${{ needs.validate-release.outputs.version }}

            ### Installation

            ```bash
            gem install dbwatcher -v ${{ needs.validate-release.outputs.version }}
            ```

            Or add to your Gemfile:

            ```ruby
            gem 'dbwatcher', '~> ${{ needs.validate-release.outputs.version }}'
            ```

            ### Changes

            See [CHANGELOG.md](CHANGELOG.md) for detailed changes in this release.

            ### Links

            - ğŸ“¦ [RubyGems](https://rubygems.org/gems/dbwatcher/versions/${{ needs.validate-release.outputs.version }})
            - ğŸ“š [Documentation](https://github.com/${{ github.repository }}/blob/v${{ needs.validate-release.outputs.version }}/README.md)
            - ğŸ› [Issues](https://github.com/${{ github.repository }}/issues)
          draft: false
          prerelease: false
          files: ${{ steps.build.outputs.gem_file }}

      - name: Upload gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbwatcher-gem-${{ needs.validate-release.outputs.version }}
          path: ${{ steps.build.outputs.gem_file }}
          retention-days: 90

  post-release:
    needs: [validate-release, build-and-publish]
    runs-on: ubuntu-latest
    name: Post-Release Tasks
    if: needs.validate-release.outputs.should_release == 'true' && github.event.inputs.dry_run != 'true'
    steps:
      - name: Verify publication
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          echo "â³ Waiting for gem to be available on RubyGems..."

          # Wait up to 5 minutes for the gem to be available
          for i in {1..30}; do
            if gem list dbwatcher --remote --exact | grep -q "($VERSION)"; then
              echo "âœ… Gem $VERSION is now available on RubyGems"
              break
            fi
            echo "Waiting... (attempt $i/30)"
            sleep 10
          done

      - name: Notify success
        run: |
          echo "ğŸ‰ Release v${{ needs.validate-release.outputs.version }} completed successfully!"
          echo "ğŸ“¦ Gem published to RubyGems"
          echo "ğŸ·ï¸ GitHub release created"
          echo "ğŸ”— https://rubygems.org/gems/dbwatcher/versions/${{ needs.validate-release.outputs.version }}"

      - name: Notify Slack - Release Complete
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          custom_payload: |
            {
              "channel": "#cicd-notifications",
              "username": "DB Watcher Release",
              "icon_emoji": ":rocket:",
              "attachments": [{
                "color": "good",
                "fallback": "DB Watcher v${{ needs.validate-release.outputs.version }} released successfully!",
                "title": "ğŸš€ DB Watcher v${{ needs.validate-release.outputs.version }} Released Successfully!",
                "title_link": "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-release.outputs.version }}",
                "text": "A new version of DB Watcher has been published to RubyGems and is ready for use! ğŸ‰",
                "fields": [
                  {
                    "title": "ğŸ“¦ Version",
                    "value": "`v${{ needs.validate-release.outputs.version }}`",
                    "short": true
                  },
                  {
                    "title": "âš¡ Trigger",
                    "value": "${{ github.event_name == 'workflow_dispatch' && 'ğŸ”§ Manual Release' || 'ğŸ·ï¸ Tag Push' }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ“¥ Installation",
                    "value": "```gem install dbwatcher -v ${{ needs.validate-release.outputs.version }}```",
                    "short": false
                  },
                  {
                    "title": "ğŸ”— Quick Links",
                    "value": "ğŸ“¦ <https://rubygems.org/gems/dbwatcher/versions/${{ needs.validate-release.outputs.version }}|RubyGems Package> â€¢ ğŸ“š <https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-release.outputs.version }}|Release Notes> â€¢ ğŸ“– <https://github.com/${{ github.repository }}|Documentation>",
                    "short": false
                  },
                  {
                    "title": "ğŸ‘¤ Released By",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ“‚ Repository",
                    "value": "<https://github.com/${{ github.repository }}|${{ github.repository }}>",
                    "short": true
                  }
                ],
                "footer": "Released via GitHub Actions â€¢ Thanks for using DB Watcher! ğŸ’",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": ${{ github.event.head_commit.timestamp }}
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-failure:
    needs: [validate-release, build-and-publish, post-release]
    runs-on: ubuntu-latest
    name: Notify on Failure
    if: always() && (failure() || cancelled()) && needs.validate-release.outputs.should_release == 'true'
    steps:
      - name: Determine failed job
        id: failed_job
        run: |
          if [[ "${{ needs.validate-release.result }}" == "failure" ]]; then
            echo "failed_step=Validation" >> $GITHUB_OUTPUT
            echo "failed_reason=Version validation or format check failed" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.build-and-publish.result }}" == "failure" ]]; then
            echo "failed_step=Build & Publish" >> $GITHUB_OUTPUT
            echo "failed_reason=Gem build or RubyGems publishing failed" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.post-release.result }}" == "failure" ]]; then
            echo "failed_step=Post-Release" >> $GITHUB_OUTPUT
            echo "failed_reason=Release verification or notification failed" >> $GITHUB_OUTPUT
          else
            echo "failed_step=Unknown" >> $GITHUB_OUTPUT
            echo "failed_reason=Workflow was cancelled or failed unexpectedly" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack - Release Failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          custom_payload: |
            {
              "channel": "#cicd-notifications",
              "username": "DB Watcher Release",
              "icon_emoji": ":x:",
              "attachments": [{
                "color": "danger",
                "fallback": "DB Watcher release failed!",
                "title": "âŒ DB Watcher Release Failed",
                "title_link": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "text": "The release process encountered an error and needs attention. Please check the logs for details.",
                "fields": [
                  {
                    "title": "ğŸ’¥ Failed Step",
                    "value": "${{ steps.failed_job.outputs.failed_step }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ“¦ Version",
                    "value": "`v${{ needs.validate-release.outputs.version || github.event.inputs.version || 'Unknown' }}`",
                    "short": true
                  },
                  {
                    "title": "ğŸ” Failure Reason",
                    "value": "${{ steps.failed_job.outputs.failed_reason }}",
                    "short": false
                  },
                  {
                    "title": "ğŸ“‚ Repository",
                    "value": "<https://github.com/${{ github.repository }}|${{ github.repository }}>",
                    "short": true
                  },
                  {
                    "title": "ğŸ”§ Workflow Run",
                    "value": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ğŸ” View Detailed Logs>",
                    "short": true
                  },
                  {
                    "title": "ğŸ‘¤ Triggered By",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ“š Troubleshooting",
                    "value": "<https://github.com/${{ github.repository }}/blob/main/docs/RELEASE_GUIDE.md#-troubleshooting|Release Guide> â€¢ <https://github.com/${{ github.repository }}/blob/main/docs/SLACK_INTEGRATION.md|Slack Integration>",
                    "short": true
                  }
                ],
                "footer": "Release process failed â€¢ Check logs and try again",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": ${{ github.event.head_commit.timestamp }}
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
